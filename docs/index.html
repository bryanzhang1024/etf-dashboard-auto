<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETF估值与性价比仪表盘 · djeva版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        body { font-family: 'Inter', 'Helvetica Neue', 'Arial', sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .sticky-head { position: sticky; top: 0; backdrop-filter: blur(8px); }
    </style>
</head>
<body class="bg-slate-950 text-slate-100">

    <div class="max-w-6xl mx-auto px-4 py-6 md:py-10 space-y-8">
        <header class="space-y-2 text-center md:text-left">
            <h1 class="text-3xl md:text-4xl font-bold text-white tracking-tight">ETF 估值与性价比仪表盘 <span class="text-sm text-slate-400 align-super">djeva 数据驱动</span></h1>
            <p class="text-sm md:text-base text-slate-400">数据来源：蛋卷基金指数估值 API + 本地价格历史，评分遵循 Value / Pain 双维度。</p>
        </header>

        <section class="grid gap-4 md:grid-cols-2">
            <article class="rounded-xl border border-slate-800 bg-slate-900/80 p-5 shadow-lg shadow-black/40">
                <h2 class="text-xs uppercase tracking-widest text-slate-400">数据摘要</h2>
                <p class="mt-3 text-lg font-medium text-slate-200">djeva 官方估值 + AkShare / Yahoo 行情</p>
                <div class="mt-4 flex flex-wrap gap-3 text-xs text-slate-400">
                    <span>最近更新：<span id="last-updated" class="text-slate-100 font-semibold"></span></span>
                    <span>覆盖指数：<span id="total-assets" class="text-slate-100 font-semibold"></span></span>
                </div>
            </article>
            <article class="rounded-xl border border-slate-800 bg-slate-900/80 p-5 shadow-lg shadow-black/40">
                <h2 class="text-xs uppercase tracking-widest text-slate-400">评分逻辑（总分 20）</h2>
                <ul class="mt-3 space-y-2 text-sm text-slate-300">
                    <li><strong class="text-slate-100">Value</strong>（0-12）：直接取官方 PE / PB 百分位较高者，百分位越低得分越高。</li>
                    <li><strong class="text-slate-100">Pain</strong>（0-8）：10 年窗口最大回撤，跌得越痛越高分。</li>
                </ul>
                <p class="mt-3 text-xs text-slate-500">股息率与 ROE 当前仅作展示参考，暂不计入得分。</p>
            </article>
        </section>

        <section class="space-y-4">
            <div class="hidden lg:block">
                <div class="overflow-hidden rounded-xl border border-slate-800/80 shadow-2xl shadow-black/40">
                    <table class="min-w-full text-sm">
                        <thead class="sticky-head bg-slate-950/90 border-b border-slate-800/70">
                            <tr class="text-xs uppercase tracking-widest text-slate-400">
                                <th scope="col" class="px-4 py-3 text-left">指数</th>
                                <th scope="col" class="px-4 py-3 text-center">代码</th>
                                <th scope="col" class="px-4 py-3 text-right">PE</th>
                                <th scope="col" class="px-4 py-3 text-right">PE百分位</th>
                                <th scope="col" class="px-4 py-3 text-right">PB</th>
                                <th scope="col" class="px-4 py-3 text-right">PB百分位</th>
                                <th scope="col" class="px-4 py-3 text-right">股息率</th>
                                <th scope="col" class="px-4 py-3 text-right">ROE</th>
                                <th scope="col" class="px-4 py-3 text-right">回撤</th>
                                <th scope="col" class="px-4 py-3 text-right">评分</th>
                            </tr>
                        </thead>
                        <tbody id="table-view" class="bg-slate-900/40 divide-y divide-slate-800/60"></tbody>
                    </table>
                </div>
            </div>

            <div class="lg:hidden space-y-4" id="card-view"></div>
        </section>

        <footer class="mt-10 border border-slate-800/70 bg-slate-900/70 rounded-xl p-5 text-sm text-slate-400 space-y-3">
            <div>
                <h3 class="text-slate-200 font-semibold mb-2">字段说明</h3>
                <p class="text-xs">CSV 列需包含：<code>index_name,index_code,etfs,pe,pe_pct,pb,pb_pct,dividend,roe,drawdown,eva_type</code>。百分位由 djeva API 提供，回撤基于本地价格序列。</p>
            </div>
            <div>
                <h3 class="text-slate-200 font-semibold mb-2">调试提示</h3>
                <p class="text-xs">如需离线预览，请确保通过本地静态服务器访问，避免 <code>file://</code> 跨域限制。</p>
            </div>
        </footer>
    </div>

    <script>
        const CSV_URL = 'assets.csv';
        const JSON_URL = 'assets.json';

        const clamp = (value, min, max) => Math.min(Math.max(value, min), max);
        const toNumber = (value) => {
            if (value === null || value === undefined || value === '') return null;
            const num = Number(value);
            return Number.isFinite(num) ? num : null;
        };
        const formatNumber = (value, digits = 2) => value === null || value === undefined ? '--' : Number(value).toFixed(digits);
        const formatPercent = (value, digits = 1) => value === null || value === undefined ? '--' : (Number(value) * 100).toFixed(digits) + '%';
        const formatPercentile = (value, digits = 1) => value === null || value === undefined ? '--' : Number(value).toFixed(digits) + '%';
        const makeStars = (count) => '★'.repeat(count) + '☆'.repeat(5 - count);

        const ratingBuckets = [
            { min: 18, label: '猎杀区', pillClass: 'bg-emerald-500/15 text-emerald-200 ring-1 ring-emerald-400/40', stars: 5 },
            { min: 14, label: '稳中求胜', pillClass: 'bg-lime-500/15 text-lime-200 ring-1 ring-lime-400/40', stars: 4 },
            { min: 10, label: '中性观察', pillClass: 'bg-slate-500/15 text-slate-200 ring-1 ring-slate-400/30', stars: 3 },
            { min: 6,  label: '高位警戒', pillClass: 'bg-amber-500/15 text-amber-200 ring-1 ring-amber-400/35', stars: 2 },
            { min: 0,  label: '泡沫区', pillClass: 'bg-red-500/15 text-red-200 ring-1 ring-red-400/35', stars: 1 },
        ];

        const EVA_BADGES = {
            low: { text: '低估', cls: 'bg-emerald-400/15 text-emerald-200 ring-1 ring-emerald-400/40' },
            mid: { text: '中性', cls: 'bg-amber-400/15 text-amber-200 ring-1 ring-amber-400/35' },
            high: { text: '高估', cls: 'bg-red-400/15 text-red-200 ring-1 ring-red-400/35' },
        };

        async function loadCSV(url) {
            const res = await fetch(url + '?ts=' + Date.now());
            if (!res.ok) throw new Error('CSV not found');
            const text = await res.text();
            const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
            if (parsed.errors.length) console.warn('CSV parse warnings:', parsed.errors);
            return parsed.data.map(r => ({
                indexName: String(r.index_name || '').trim(),
                indexCode: String(r.index_code || '').trim(),
                etfs: String(r.etfs || '').split(';').map(s => s.trim()).filter(Boolean),
                pe: toNumber(r.pe),
                pePercentile: toNumber(r.pe_pct),
                pb: toNumber(r.pb),
                pbPercentile: toNumber(r.pb_pct),
                dividendYield: toNumber(r.dividend),
                roe: toNumber(r.roe),
                drawdown: toNumber(r.drawdown),
                evaType: String(r.eva_type || '').trim(),
            })).filter(x => x.indexName);
        }

        async function loadJSON(url) {
            const res = await fetch(url + '?ts=' + Date.now());
            if (!res.ok) throw new Error('JSON not found');
            return await res.json();
        }

        async function loadAssetsData() {
            try { return await loadCSV(CSV_URL); }
            catch (_) {
                try { return await loadJSON(JSON_URL); }
                catch (e) {
                    console.error('数据文件未找到，使用内置示例。', e);
                    return [
                        {
                            indexName: '中证500', indexCode: 'SH000905', etfs: ['510500.SS'],
                            pe: 35.05, pePercentile: 82.0, pb: 2.33, pbPercentile: 73.0,
                            dividendYield: 0.0135,
                            roe: 0.066,
                            drawdown: 0.32, evaType: 'high'
                        }
                    ];
                }
            }
        }

        function calculateScore(asset) {
            const pePct = Number.isFinite(asset.pePercentile) ? asset.pePercentile : 100;
            const pbPct = Number.isFinite(asset.pbPercentile) ? asset.pbPercentile : 100;
            const valuePct = Math.max(pePct, pbPct);
            const drawdown = Number.isFinite(asset.drawdown) ? asset.drawdown : 0;

            const valueScore = clamp(Math.round((100 - valuePct) / 8), 0, 12);
            const painScore = clamp(Math.round(drawdown * 16), 0, 8);

            const total = valueScore + painScore;
            const rating = ratingBuckets.find(bucket => total >= bucket.min) || ratingBuckets.at(-1);

            return {
                total,
                rating,
                breakdown: { valueScore, painScore },
            };
        }

        function percentileCell(value) {
            if (!Number.isFinite(value)) return '<span class="text-slate-500">--</span>';
            const pct = clamp(value, 0, 100);
            const gradient = `background: linear-gradient(90deg, rgba(56,189,248,0.22) 0%, rgba(249,115,22,0.35) ${pct}%, rgba(15,23,42,0) ${pct}%);`;
            return `<span class="block px-2 py-1 text-sm font-semibold text-sky-100 rounded-md" style="${gradient}">${pct.toFixed(1)}%</span>`;
        }

        function drawdownCell(value) {
            if (!Number.isFinite(value)) return '<span class="text-slate-500">--</span>';
            const pct = clamp(value * 100, 0, 100);
            const gradient = `background: linear-gradient(90deg, rgba(16,185,129,0.22) 0%, rgba(8,145,178,0.28) ${pct}%, rgba(15,23,42,0) ${pct}%);`;
            return `<span class="block px-2 py-1 text-sm font-semibold text-teal-100 rounded-md" style="${gradient}">${pct.toFixed(1)}%</span>`;
        }

        function ratingPill(score) {
            return `<span class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-sm font-semibold ${score.rating.pillClass}"><span>${score.total}</span><span class="text-xs font-medium">${score.rating.label}</span></span>`;
        }

        function renderTable(assets) {
            const tbody = document.getElementById('table-view');
            tbody.innerHTML = assets.map(asset => {
                const score = calculateScore(asset);
                const evaKey = (asset.evaType || '').toLowerCase();
                const badge = EVA_BADGES[evaKey] || EVA_BADGES.mid;
                const etfText = asset.etfs.join(', ');
                return `
                    <tr class="group transition hover:bg-slate-900/70">
                        <td class="px-4 py-4 align-middle">
                            <div class="flex flex-col gap-2" title="${etfText || '无 ETF 对应'}">
                                <div class="flex flex-wrap items-center gap-3">
                                    <span class="text-base font-semibold text-white group-hover:text-sky-200 transition">${asset.indexName}</span>
                                    <span class="inline-flex items-center px-2.5 py-0.5 text-xs font-semibold rounded-md ${badge.cls}">${badge.text}</span>
                                </div>
                                <div class="text-xs text-slate-500 flex items-center gap-2">
                                    <span class="uppercase tracking-wide text-slate-400">ETF:</span>
                                    <span class="truncate max-w-[360px]">${etfText || '—'}</span>
                                </div>
                            </div>
                        </td>
                        <td class="px-4 py-4 text-center text-sm text-slate-300">${asset.indexCode || '--'}</td>
                        <td class="px-4 py-4 text-right text-sm text-slate-200">${formatNumber(asset.pe, 2)}</td>
                        <td class="px-4 py-4 text-right">${percentileCell(asset.pePercentile)}</td>
                        <td class="px-4 py-4 text-right text-sm text-slate-200">${formatNumber(asset.pb, 2)}</td>
                        <td class="px-4 py-4 text-right">${percentileCell(asset.pbPercentile)}</td>
                        <td class="px-4 py-4 text-right text-sm text-slate-200">${formatPercent(asset.dividendYield, 2)}</td>
                        <td class="px-4 py-4 text-right text-sm text-slate-200">${formatPercent(asset.roe, 2)}</td>
                        <td class="px-4 py-4 text-right">${drawdownCell(asset.drawdown)}</td>
                        <td class="px-4 py-4 text-right">${ratingPill(score)}</td>
                    </tr>
                `;
            }).join('');
        }

        function renderCards(assets) {
            const container = document.getElementById('card-view');
            container.innerHTML = '';
            assets.forEach((asset, index) => {
                const score = calculateScore(asset);
                const evaKey = (asset.evaType || '').toLowerCase();
                const badge = EVA_BADGES[evaKey] || EVA_BADGES.mid;
                const stars = ratingBuckets.indexOf(score.rating) >= 0 ? makeStars(score.rating.stars) : makeStars(3);
                const card = `
                    <article class="rounded-xl border border-slate-800 bg-slate-900/70 p-5 shadow-lg shadow-black/40" data-index="${index}">
                        <div class="flex flex-wrap items-start justify-between gap-3">
                            <div>
                                <div class="flex items-center gap-2">
                                    <h2 class="text-lg font-semibold text-white">${asset.indexName}</h2>
                                    <span class="inline-flex items-center px-2 py-0.5 text-xs font-semibold rounded-md ${badge.cls}">${badge.text}</span>
                                </div>
                                <p class="text-xs text-slate-500 mt-1">${asset.indexCode} · ${asset.etfs.join(', ') || '—'}</p>
                            </div>
                            <div class="text-right">
                                <div class="text-3xl font-bold text-white">${score.total}</div>
                                <div class="text-xs text-slate-400">${score.rating.label}</div>
                                <div class="text-sm text-amber-400">${stars}</div>
                            </div>
                        </div>
                        <dl class="mt-4 grid grid-cols-2 gap-3 text-sm">
                            <div class="space-y-1">
                                <dt class="text-xs text-slate-500">PE / 百分位</dt>
                                <dd class="font-semibold text-slate-100">${formatNumber(asset.pe, 2)} · ${formatPercentile(asset.pePercentile)}</dd>
                            </div>
                            <div class="space-y-1">
                                <dt class="text-xs text-slate-500">PB / 百分位</dt>
                                <dd class="font-semibold text-slate-100">${formatNumber(asset.pb, 2)} · ${formatPercentile(asset.pbPercentile)}</dd>
                            </div>
                            <div class="space-y-1">
                                <dt class="text-xs text-slate-500">股息率</dt>
                                <dd class="font-semibold text-teal-100">${formatPercent(asset.dividendYield, 2)}</dd>
                            </div>
                            <div class="space-y-1">
                                <dt class="text-xs text-slate-500">ROE</dt>
                                <dd class="font-semibold text-sky-100">${formatPercent(asset.roe, 2)}</dd>
                            </div>
                            <div class="space-y-1">
                                <dt class="text-xs text-slate-500">回撤</dt>
                                <dd class="font-semibold text-emerald-200">${formatPercent(asset.drawdown, 1)}</dd>
                            </div>
                            <div class="space-y-1">
                                <dt class="text-xs text-slate-500">Value / Pain</dt>
                                <dd class="font-semibold text-slate-100">${score.breakdown.valueScore} / ${score.breakdown.painScore}</dd>
                            </div>
                        </dl>
                    </article>
                `;
                container.insertAdjacentHTML('beforeend', card);
            });
        }

        (async function () {
            const data = await loadAssetsData();
            const sorted = [...data].sort((a, b) => calculateScore(b).total - calculateScore(a).total);

            document.getElementById('last-updated').textContent = new Date().toLocaleString('zh-CN', { hour12: false });
            document.getElementById('total-assets').textContent = sorted.length;

            renderTable(sorted);
            renderCards(sorted);
        })();
    </script>
</body>
</html>
