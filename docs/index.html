<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETF估值与性价比仪表盘 · djeva版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        body { font-family: 'Inter', 'Helvetica Neue', 'Arial', sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .details-content { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; }
        .details-content.open { max-height: 520px; }
        .star-rating { font-size: 1.4rem; line-height: 1.6rem; }
        .badge { display:inline-block; padding:2px 6px; border-radius:6px; font-size:12px; margin-left:8px; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-white mb-2">ETF 估值与性价比仪表盘 <span class="text-sm text-gray-400">djeva 数据驱动</span></h1>
            <p class="text-gray-400">数据来源：<code>docs/assets.csv</code>（自动构建）或 <code>assets.json</code> 备用</p>
        </header>

        <main id="dashboard-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></main>

        <footer class="mt-12 p-6 bg-gray-800 rounded-lg text-gray-300 space-y-4">
            <div>
                <h2 class="text-xl font-semibold text-white mb-2">数据字段</h2>
                <p class="text-sm text-gray-400">CSV 列：<code>index_name,index_code,etfs,pe,pe_pct,pb,pb_pct,dividend,dividend_pct,roe,roe_pct,drawdown,eva_type</code></p>
                <p class="text-xs text-gray-500">百分位取过去十年窗口（若历史不足则使用全量），股息率/ROE 以 djeva TTM 数据为准，回撤基于本地价格序列。</p>
            </div>
            <div>
                <h2 class="text-xl font-semibold text-white mb-2">评分体系（总分 20）</h2>
                <ul class="list-disc list-inside space-y-1 text-sm">
                    <li><strong>价值 Value（0-12）</strong>：直接使用蛋卷提供的 PE / PB 百分位，取最大者；<code>value = clamp(round((100 - pct) / 8), 0, 12)</code></li>
                    <li><strong>疼痛 Pain（0-8）</strong>：回撤越深越好；<code>pain = clamp(round(drawdown * 16), 0, 8)</code></li>
                </ul>
                <p class="text-xs text-gray-500">股息率与 ROE 目前仅展示当前值，用于人工判断，不纳入自动评分。</p>
            </div>
        </footer>
    </div>

    <script>
        const CSV_URL = 'assets.csv';
        const JSON_URL = 'assets.json';

        const clamp = (value, min, max) => Math.min(Math.max(value, min), max);
        const toNumber = (value) => {
            if (value === null || value === undefined || value === '') return null;
            const num = Number(value);
            return Number.isFinite(num) ? num : null;
        };
        const formatNumber = (value, digits = 2) => value === null || value === undefined ? '--' : Number(value).toFixed(digits);
        const formatPercent = (value, digits = 1) => value === null || value === undefined ? '--' : (Number(value) * 100).toFixed(digits) + '%';
        const formatPercentile = (value, digits = 1) => value === null || value === undefined ? '--' : Number(value).toFixed(digits) + '%';
        const makeStars = (count) => '★'.repeat(count) + '☆'.repeat(5 - count);

        const ratingBuckets = [
            { min: 17, label: '猎杀区', classes: 'bg-green-900/40 border-green-500/70', stars: 5 },
            { min: 14, label: '稳中求胜', classes: 'bg-lime-900/30 border-lime-500/60', stars: 4 },
            { min: 10, label: '中性观察', classes: 'bg-slate-800/40 border-slate-500/50', stars: 3 },
            { min: 6,  label: '高位警戒', classes: 'bg-amber-900/30 border-amber-500/60', stars: 2 },
            { min: 0,  label: '泡沫区', classes: 'bg-red-900/30 border-red-500/60', stars: 1 },
        ];

        async function loadCSV(url) {
            const res = await fetch(url + '?ts=' + Date.now());
            if (!res.ok) throw new Error('CSV not found');
            const text = await res.text();
            const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
            if (parsed.errors.length) console.warn('CSV parse warnings:', parsed.errors);
            return parsed.data.map(r => ({
                indexName: String(r.index_name || '').trim(),
                indexCode: String(r.index_code || '').trim(),
                etfs: String(r.etfs || '').split(';').map(s => s.trim()).filter(Boolean),
                pe: toNumber(r.pe),
                pePercentile: toNumber(r.pe_pct),
                pb: toNumber(r.pb),
                pbPercentile: toNumber(r.pb_pct),
                dividendYield: toNumber(r.dividend),
                roe: toNumber(r.roe),
                drawdown: toNumber(r.drawdown),
                evaType: String(r.eva_type || '').trim(),
            })).filter(x => x.indexName);
        }

        async function loadJSON(url) {
            const res = await fetch(url + '?ts=' + Date.now());
            if (!res.ok) throw new Error('JSON not found');
            return await res.json();
        }

        async function loadAssetsData() {
            try { return await loadCSV(CSV_URL); }
            catch (_) {
                try { return await loadJSON(JSON_URL); }
                catch (e) {
                    console.error('数据文件未找到，使用内置示例。', e);
                    return [
                        {
                            indexName: '中证500', indexCode: 'SH000905', etfs: ['510500.SS'],
                            pe: 35.05, pePercentile: 82.0, pb: 2.33, pbPercentile: 73.0,
                            dividendYield: 0.0135,
                            roe: 0.066,
                            drawdown: 0.32, evaType: 'high'
                        }
                    ];
                }
            }
        }

        function calculateScore(asset) {
            const pePct = Number.isFinite(asset.pePercentile) ? asset.pePercentile : 100;
            const pbPct = Number.isFinite(asset.pbPercentile) ? asset.pbPercentile : 100;
            const valuePct = Math.max(pePct, pbPct);
            const drawdown = Number.isFinite(asset.drawdown) ? asset.drawdown : 0;

            const valueScore = clamp(Math.round((100 - valuePct) / 8), 0, 12);
            const painScore = clamp(Math.round(drawdown * 16), 0, 8);

            const total = valueScore + painScore;
            const rating = ratingBuckets.find(bucket => total >= bucket.min) || ratingBuckets.at(-1);

            return {
                total,
                ratingLabel: rating.label,
                ratingClasses: rating.classes,
                stars: makeStars(rating.stars),
                breakdown: { valueScore, painScore },
            };
        }

        function createDetailRow(label, value, extra) {
            return `
                <div class="flex flex-col gap-1 p-3 bg-gray-800/60 rounded-md">
                    <span class="text-xs uppercase tracking-wide text-gray-400">${label}</span>
                    <span class="text-lg font-semibold text-white">${value}</span>
                    <span class="text-xs text-gray-500">${extra}</span>
                </div>`;
        }

        function renderDashboard(assets) {
            const grid = document.getElementById('dashboard-grid');
            assets.sort((a, b) => calculateScore(b).total - calculateScore(a).total);
            grid.innerHTML = '';

            assets.forEach((asset, index) => {
                const score = calculateScore(asset);
                const details = [
                    createDetailRow('PE', formatNumber(asset.pe), `百分位 ${formatPercentile(asset.pePercentile)}`),
                    createDetailRow('PB', formatNumber(asset.pb), `百分位 ${formatPercentile(asset.pbPercentile)}`),
                    createDetailRow('股息率', formatPercent(asset.dividendYield), '来自 djeva TTM'),
                    createDetailRow('ROE', formatPercent(asset.roe, 1), '来自 djeva TTM'),
                    createDetailRow('回撤', formatPercent(asset.drawdown), `Pain 得分 ${score.breakdown.painScore}`),
                    createDetailRow('价值得分', score.breakdown.valueScore, 'Value (0-12)'),
                ].join('');

                const cardHTML = `
                    <div class="asset-card border-2 rounded-lg p-5 ${score.ratingClasses} transition-all duration-300 hover:shadow-lg hover:shadow-gray-800/50 hover:border-gray-500 cursor-pointer" data-index="${index}">
                        <div class="flex justify-between items-start gap-4">
                            <div>
                                <h2 class="text-xl font-bold text-white">${asset.indexName} <span class="text-sm font-normal text-gray-400">${asset.indexCode}</span></h2>
                                <p class="text-xs text-gray-400">${asset.etfs.join(', ') || '—'}</p>
                            </div>
                            <div class="text-right">
                                <div class="text-3xl font-bold text-white">${score.total} <span class="text-base">分</span></div>
                                <div class="star-rating">${score.stars}</div>
                            </div>
                        </div>
                        <div class="mt-4 text-center text-sm font-medium rounded-md px-3 py-1 bg-white/10 text-white">${score.ratingLabel}</div>
                        <div class="details-content mt-4 pt-4 border-t border-gray-700" id="details-${index}">
                            <div class="grid grid-cols-2 gap-3">${details}</div>
                        </div>
                    </div>`;
                grid.insertAdjacentHTML('beforeend', cardHTML);
            });

            document.querySelectorAll('.asset-card').forEach((card, i) => {
                card.addEventListener('click', () => {
                    const details = document.getElementById(`details-${i}`);
                    details.classList.toggle('open');
                });
            });
        }

        (async function () {
            const data = await loadAssetsData();
            renderDashboard(data);
        })();
    </script>
</body>
</html>
